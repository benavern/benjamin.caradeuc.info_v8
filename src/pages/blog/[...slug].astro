---
import Layout from "../../components/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const posts = await getCollection("blog");

    return posts.map((post) => ({
        params: { slug: post.slug },
        props: { post },
    }));
}

const { post } = Astro.props;

// 1️⃣ Récupérer tous les posts
const allPosts = (await getCollection("blog")).sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

// 2️⃣ Trouver l’index du post courant
const index = allPosts.findIndex((p) => p.slug === post.slug);

// 3️⃣ Déterminer précédent et suivant
const prevPost = index < allPosts.length - 1 ? allPosts[index + 1] : null;
const nextPost = index > 0 ? allPosts[index - 1] : null;
---

<Layout title={post.data.title}>
    <article class="blog-post">
        <h1>{post.data.title}</h1>

        <img
            src={post.data.featured_image || "/images/default_img.jpg"}
            alt={`Featured image for ${post.data.title}`}
            class="featured-image"
        />

        <p>
            Publié le

            <time datetime={post.data.date.toISOString()}>
                {post.data.date.toLocaleDateString("fr-FR", { dateStyle: 'long'})}
            </time>
        </p>

        <p class="blog-post__tags">
            {post.data.tags?.map((t, i) => <a class="btn btn--variant-primary-border" href={`/blog/tags/${t}/`}>{t}</a>)}
        </p>

        {
            post.rendered?.html && (
                <div class="content" set:html={post.rendered.html} />
            )
        }

        <hr />

        <nav class="post-navigation">
            {
                prevPost && (
                    <a class="prev" href={`/blog/${prevPost.slug}/`}>
                        ← {prevPost.data.title}
                    </a>
                )
            }
            {
                nextPost && (
                    <a class="next" href={`/blog/${nextPost.slug}/`}>
                        {nextPost.data.title} →
                    </a>
                )
            }
        </nav>
    </article>
</Layout>


<style lang="scss">
    .blog-post {
        .featured-image {
            width: 100%;
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
        }

        .blog-post__tags {
            display: flex;
            gap: var(--spacing);
            flex-wrap: wrap;
            margin-bottom: var(--spacing);
        }

        .post-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;

            a {
                text-decoration: none;
                color: var(--color-primary);
                font-weight: bold;

                &.prev {
                    text-align: left;
                }

                &.next {
                    text-align: right;
                }
            }
        }
    }
</style>
