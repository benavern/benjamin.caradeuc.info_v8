---
interface Props {
  count?: number;
}

const { count = 9 } = Astro.props;
const fireflyArray = Array.from({ length: count });
---

<div class="gradient-background">
  {fireflyArray.map(() => <div class="firefly"></div>)}
</div>

<style lang="scss">
.gradient-background {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: clip;
}

.firefly {
  position: absolute;
  width: min(60vw, 600px);
  height: min(60vw, 600px);
  border-radius: 50%;
  filter: blur(12px);
  opacity: 0.15;
  pointer-events: none;
  will-change: transform;
  background-image: radial-gradient(circle, var(--clr-primary) 0%, transparent 70%);

  &:nth-child(2n + 1) {
    background-image: radial-gradient(circle, var(--clr-accent) 0%, transparent 70%);
  }
}

</style>

<script>
type Firefly = {
  el: HTMLDivElement,
  x: number,
  y: number,
  dx: number,
  dy: number,
  speed: number,
  phase: number,
};

let animId: number | null = null;
let resizeHandler: (() => void) | null = null;

function animate(fireflies: Firefly[], container: HTMLDivElement) {
  if (!document.body.contains(container)) {
    // le container n'existe plus, on stoppe l'animation
    animId = null;
    return;
  }

  const time = Date.now();
  const width = container.clientWidth;
  const height = container.clientHeight;

  for (const f of fireflies) {
    f.x += f.dx * f.speed;
    f.y += f.dy * f.speed;

    if (f.x < 0 || f.x > width) f.dx = -f.dx;
    if (f.y < 0 || f.y > height) f.dy = -f.dy;

    f.dx += (Math.random() - 0.5) * 0.05;
    f.dy += (Math.random() - 0.5) * 0.05;

    const offsetX = Math.sin(time / 1000 + f.phase) * 10;
    const offsetY = Math.cos(time / 1200 + f.phase) * 10;

    f.el.style.transform = `translate(${f.x - f.el.offsetWidth / 2 + offsetX}px, ${f.y - f.el.offsetHeight / 2 + offsetY}px)`;
  }

  animId = requestAnimationFrame(() => animate(fireflies, container));
}

function setupFireflies() {
    const container = document.querySelector<HTMLDivElement>('.gradient-background');
    if (!container) return;

    if (resizeHandler) window.removeEventListener('resize', resizeHandler);

    // annule l'ancienne animation
    if (animId) cancelAnimationFrame(animId);


    // récupérer les divs déjà présentes
    const fireflies: Firefly[] = Array.from(container.querySelectorAll<HTMLDivElement>('.firefly')).map(el => ({
        el,
        x: Math.random() * container.clientWidth,
        y: Math.random() * container.clientHeight,
        dx: (Math.random() - 0.5) * 2,
        dy: (Math.random() - 0.5) * 2,
        speed: 0.25 + Math.random() * 0.1,
        phase: Math.random() * Math.PI * 2,
    }));


    resizeHandler = () => {
        for (const f of fireflies) {
        f.x = Math.random() * container.clientWidth;
        f.y = Math.random() * container.clientHeight;
        }
    };
    window.addEventListener('resize', resizeHandler);

    animate(fireflies, container);
}

// première animation
setupFireflies();

// relancer après chaque navigation client-side Astro
document.addEventListener('astro:after-swap', () => {
  setupFireflies();
});
</script>
